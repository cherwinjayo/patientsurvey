<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Patient Satisfaction Survey</title>
  <script src="https://tally.so/widgets/embed.js"></script>

  <style>
    body{font-family:Arial,sans-serif;padding:20px;max-width:900px;margin:auto;background:#f7faff}
    h2{text-align:center;margin-bottom:20px}
    .hidden{display:none}
    
    .thankyou, .blocked {
      padding:20px;
      border-radius:10px;
      margin-bottom:20px;
      font-size:1.1rem;
    }
    .thankyou {
      background:#e0ffe0;
      border:1px solid #4CAF50;
    }
    .blocked {
      background:#ffe6e6;
      border:1px solid #ff4d4d;
    }
  </style>
</head>

<body>

<h2>Patient Satisfaction Survey</h2>

<div id="thankyou" class="thankyou hidden">
  <strong>شكراً لك على تعبئة الاستبيان! Thank you for submitting the survey!</strong><br><br>
  تم تسجيل ردك بنجاح. Your response has been recorded.
</div>

<div id="block-message" class="blocked hidden">
  <strong>لقد قمت بتعبئة هذا الاستبيان مسبقاً. You have already submitted this survey.</strong><br><br>
  يرجى الانتظار لمدة Please wait <span id="remaining-time"></span> قبل أن تتمكن من الإجابة مرة أخرى. before you can answer again.
</div>

<div id="form-container" class="hidden">
  <iframe 
    data-tally-src="https://tally.so/r/VLLvPy"
    width="100%" height="1000" frameborder="0"></iframe>
</div>

<script>
(function(){
  const FORM_KEY = "patient_survey_timestamp";
  const SHOWED_THANKYOU = "survey_thankyou_shown";
  const THREE_DAYS = 3 * 24 * 60 * 60 * 1000;

  const thankyou = document.getElementById("thankyou");
  const formContainer = document.getElementById("form-container");
  const blockMsg = document.getElementById("block-message");
  const remain = document.getElementById("remaining-time");

  function msToTime(ms){
    const d = Math.floor(ms / (24*60*60*1000));
    const h = Math.floor((ms % (24*60*60*1000))/(60*60*1000));
    const m = Math.floor((ms % (60*60*1000)) / (60*1000));
    return `${d}d ${h}h ${m}m`;
  }

  function stripQuery() {
    if(window.history.replaceState){
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  }

  function isTallyRedirect() {
    const qs = new URLSearchParams(window.location.search);
    const submitted = qs.get("submitted") === "1";
    const fromTally = qs.get("from") === "tally";
    return submitted && fromTally;
  }

  function checkAccess(){
    const lastSubmit = localStorage.getItem(FORM_KEY);

    if(!lastSubmit){
      formContainer.classList.remove("hidden");
      return;
    }

    const diff = Date.now() - parseInt(lastSubmit, 10);

    if(diff >= FOUR_DAYS){
      formContainer.classList.remove("hidden");
      return;
    }

    blockMsg.classList.remove("hidden");
    remain.textContent = msToTime(FOUR_DAYS - diff);
  }

  // Handle Tally redirect
  if(isTallyRedirect()){
    // show thankyou message once
    thankyou.classList.remove("hidden");

    // save timestamp
    localStorage.setItem(FORM_KEY, Date.now().toString());

    // mark thankyou shown (so only shows once)
    localStorage.setItem(SHOWED_THANKYOU, "1");

    stripQuery();
    return;
  }

  // If thankyou was shown already → don't show form again
  if(localStorage.getItem(SHOWED_THANKYOU)){
    checkAccess();
  } else {
    formContainer.classList.remove("hidden");
  }

  if(window.Tally && Tally.loadEmbeds){
    Tally.loadEmbeds();
  }
})();
</script>

</body>
</html>

